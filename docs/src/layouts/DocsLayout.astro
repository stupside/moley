---
import { documentationPages } from "../content/pages.js";
import { layoutClasses } from "../components/layout/shared.js";
import { buildUrl } from "../utils/content.js";
import BaseLayout from "./BaseLayout.astro";

const { title } = Astro.props;
const currentPath = Astro.url.pathname;

const nav = documentationPages
	.filter((page) => !page.meta.internal)
	.reduce(
		(acc, page) => {
			if (!page.meta.category) {
				return acc;
			}

			const href = page.meta.href;
			const title = page.meta.menuTitle || page.meta.title;
			const category = page.meta.category;

			if (!acc[category]) {
				acc[category] = [];
			}

			acc[category].push({
				href,
				title,
				order: page.meta.order ?? 999,
			});

			return acc;
		},
		{} as Record<
			string,
			{
				title: string;
				href: string;
				order: number;
			}[]
		>,
	);

Object.values(nav).forEach((pages) => {
	pages.sort((a, b) => a.order - b.order);
});
---

<BaseLayout>
  <slot name="head" slot="head" />
  <div class="min-h-screen bg-gray-50" transition:persist>
    <div class={layoutClasses.container}>
      <div class="flex">
        <!-- Enhanced Left Sidebar with Categories -->
        <aside class="w-40 lg:w-48 flex-shrink-0" transition:persist="sidebar">
          <div class="sticky top-20 py-8">
            <nav class="flex flex-col gap-6">
              <div>
                <h2 class="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-4">
                  Documentation
                </h2>

                <div class="flex flex-col gap-6">
                  {Object.entries(nav).map(([category, items]) => (
                    <div class="flex flex-col gap-3">
                      <h3 class="text-xs font-medium text-gray-500 uppercase tracking-wide">
                        {category}
                      </h3>
                      <div class="flex flex-col gap-1">
                        {items.map((item) => {
                          const isActive = currentPath === item.href;
                          return (
                            <a
                              href={buildUrl(item.href)}
                              class:list={[
                                "block w-full py-2 px-1 text-sm font-medium transition-colors rounded-lg",
                                {
                                  "text-orange-700 font-semibold": isActive,
                                  "text-gray-600 hover:text-orange-600":
                                    !isActive,
                                },
                              ]}
                            >
                              {item.title}
                            </a>
                          );
                        })}
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              <!-- Action Slots -->
              <slot name="sidebar-actions" />
            </nav>
          </div>
        </aside>

        <!-- Main Content with Enhanced Layout -->
        <main class="flex-1 min-w-0 py-8 pl-8 pr-8">
          <div class="flex gap-8">
            <div class="flex-1 min-w-0">
              <div
                class="bg-white rounded-lg shadow-sm border border-gray-200 min-h-full"
              >
                <!-- Header Section -->
                <header class="px-8 py-6 border-b border-gray-100">
                  <div class="flex items-start justify-between">
                    <div class="flex-1">
                      <h1
                        class="text-4xl font-bold text-gray-900"
                        transition:name={`title-${title}`}
                      >
                        {title}
                      </h1>
                    </div>

                    <!-- Header Actions Slot -->
                    <slot name="header-actions" />
                  </div>
                </header>

                <!-- Content Section -->
                <div class="px-8 py-8">
                  <article class="max-w-none">
                    <slot />
                  </article>

                </div>
              </div>
            </div>

            <!-- Right Sidebar Slot for TOC -->
            <slot name="right-sidebar" />
          </div>
        </main>
      </div>
    </div>
  </div>
</BaseLayout>
