---
import { documentationPages } from "../content/pages.js";
import BaseLayout from "./BaseLayout.astro";

const { title } = Astro.props;
const currentPath = Astro.url.pathname;

const nav = documentationPages
	.filter((page) => !page.meta.internal)
	.reduce(
		(acc, page) => {
			if (!page.meta.category) {
				return acc;
			}

			const href =
				page.meta.href ||
				`/docs/${
					page.meta.slug ||
					page.meta.title
						.toLowerCase()
						.replace(/[^\w\s-]/g, "")
						.replace(/\s+/g, "-")
				}/`;
			const title = page.meta.menuTitle || page.meta.title;
			const category = page.meta.category;

			if (!acc[category]) {
				acc[category] = [];
			}

			acc[category].push({
				href,
				title,
				order: page.meta.order ?? 999,
			});

			return acc;
		},
		{} as Record<
			string,
			{
				title: string;
				href: string;
				order: number;
			}[]
		>,
	);

Object.values(nav).forEach((pages) => {
	pages.sort((a, b) => a.order - b.order);
});
---

<BaseLayout>
  <slot name="head" slot="head" />
  <div class="min-h-screen bg-gray-50" transition:persist>
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="flex">
        <!-- Enhanced Left Sidebar with Categories -->
        <aside class="w-40 lg:w-48 flex-shrink-0" transition:persist="sidebar">
          <div class="sticky top-20 py-8">
            <nav class="space-y-6">
              <div>
                <h2
                  class="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-4"
                >
                  Documentation
                </h2>

                {
                  Object.entries(nav).map(([category, items]) => (
                    <div class="mb-4">
                      <h3 class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">
                        {category}
                      </h3>
                      <div class="space-y-1">
                        {items.map((item) => {
                          const isActive = currentPath === item.href;
                          return (
                            <a
                              href={item.href}
                              class:list={[
                                "block w-full px-3 py-2 text-sm font-medium rounded-md transition-colors",
                                {
                                  "bg-gray-100 text-gray-900": isActive,
                                  "text-gray-600 hover:bg-gray-100 hover:text-gray-900":
                                    !isActive,
                                },
                              ]}
                            >
                              {item.title}
                            </a>
                          );
                        })}
                      </div>
                    </div>
                  ))
                }
              </div>

              <!-- Action Slots -->
              <slot name="sidebar-actions" />
            </nav>
          </div>
        </aside>

        <!-- Main Content with Enhanced Layout -->
        <main class="flex-1 min-w-0 py-8 pl-8 pr-8">
          <div class="flex gap-8">
            <div class="flex-1 min-w-0">
              <div
                class="bg-white rounded-lg shadow-sm border border-gray-200 min-h-full"
              >
                <!-- Header Section -->
                <header class="px-8 py-6 border-b border-gray-100">
                  <div class="flex items-start justify-between">
                    <div class="flex-1">
                      <h1
                        class="text-4xl font-bold text-gray-900 mb-2"
                        transition:name={`title-${title}`}
                      >
                        {title}
                      </h1>
                    </div>

                    <!-- Header Actions Slot -->
                    <slot name="header-actions" />
                  </div>
                </header>

                <!-- Content Section -->
                <div class="px-8 py-8">
                  <article class="prose prose-gray prose-lg max-w-none">
                    <slot />
                  </article>

                  <!-- Footer Slot for things like "Edit on GitHub" -->
                  <footer class="mt-12 pt-8 border-t border-gray-100">
                    <slot name="content-footer" />
                  </footer>
                </div>
              </div>
            </div>

            <!-- Right Sidebar Slot for TOC -->
            <slot name="right-sidebar" />
          </div>
        </main>
      </div>
    </div>
  </div>
</BaseLayout>
